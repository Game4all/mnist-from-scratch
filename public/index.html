<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Cache-Control" content="no-cache">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MNIST from scratch</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.js"></script>
    <script type="module">
        var canvas = new fabric.Canvas('user-canvas');
        canvas.isDrawingMode = true;
        canvas.freeDrawingBrush.width = 28;
        canvas.freeDrawingBrush.color = "#000000";

        const srcCanvas = document.getElementById("user-canvas");
        const srcCanvasCtx = srcCanvas.getContext("2d");

        const croppedCanvas = new OffscreenCanvas(28, 28);
        const croppedCtx = croppedCanvas.getContext('2d');

        const resultCanvas = document.getElementById("results");
        const resultCanvasCtx = resultCanvas.getContext("2d");

        const model = await WebAssembly.instantiateStreaming(fetch("webmnist.wasm"));

        console.log("Model initialization returned : " + (model.instance.exports.init() != 0 ? "an error" : "OK"))

        /// Crops the canvas in an offscreen canvas and stores the data for in the input tensor memory.
        function cropImage() {
            croppedCtx.clearRect(0, 0, croppedCanvas.width, croppedCanvas.height);
            croppedCtx.drawImage(srcCanvas, 0, 0, srcCanvas.width, srcCanvas.height, 0, 0, croppedCanvas.width, croppedCanvas.height);
            croppedCtx.commit();

            // convert data to grayscale
            const imgData = croppedCtx.getImageData(0, 0, croppedCanvas.width, croppedCanvas.height, {});
            var grayScaleImgData = new Float32Array(model.instance.exports.memory.buffer, model.instance.exports.getInputDataPointer(), imgData.width * imgData.height)
            for (var i = 0; i < imgData.data.length; i += 4) {
                var a = imgData.data[i + 3];
                grayScaleImgData[i / 4] = a / 256.0;
            }
        }

        // clear button
        document.getElementById("clear-btn").addEventListener("click", (_, __) => {
            canvas.clear();
            document.getElementById("pred-class").textContent = "Prediction : ???";

            resultCanvasCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);
        });

        canvas.on("mouse:up", _ => {
            canvas.renderAll();
            cropImage();

            const result = model.instance.exports.runInference();
            const logits = new Float32Array(model.instance.exports.memory.buffer, model.instance.exports.getOutputLogitsPointer(), 10);
            document.getElementById("pred-class").textContent = `Prediction : ${result} (${(logits[result] * 100.0).toFixed(2)}%)`

            resultCanvasCtx.clearRect(0, 0, resultCanvas.width, resultCanvas.height);

            const barWidth = resultCanvas.width / 10 - 10;
            for (let i = 0; i < logits.length; i++) {
                resultCanvasCtx.fillStyle = 'cyan';
                resultCanvasCtx.fillRect(
                    (resultCanvas.width / 10) * i + 5,
                    resultCanvas.height - 20,
                    barWidth,
                    -logits[i] * 50
                );

                const text = i.toString();
                const textWidth = resultCanvasCtx.measureText(text).width;
                const textX = (resultCanvas.width / 10) * i + 5 + (barWidth / 2) - (textWidth / 2);

                resultCanvasCtx.fillStyle = 'black';
                resultCanvasCtx.fillText(text, textX, 10);
            }

        });
    </script>
</head>

<body>
    <div class="flex flex-col items-center justify-center p-5 space-y-5">
        <h1 class="text-3xl font-bold">MNIST from scratch</h1>
        <div class="flex flex-row space-x-2">
            <div class="bg-gray-200 rounded-md p-5 shadow-xl">
                <canvas width="250" height="250" id="user-canvas"></canvas>
            </div>
        </div>
        <div class="flex flex-row">
            <button class="rounded-md bg-red-500 p-1 font-bold" id="clear-btn">Clear</button>
        </div>
        <img id="name" src=""></img>
        <p class="text-xl font-bold" id="pred-class">Prediction : ???</p>

        <div class="bg-gray-200 rounded-md p-5 shadow-xl">
            <canvas id="results" width="400" height="100"></canvas>
        </div>
    </div>

    <div class="fixed bottom-5 left-5">
        <p>Powered by Zig âš¡ + WebAssembly ðŸŸª</p>
    </div>
</body>

</html>